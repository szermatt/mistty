; -*- mode: emacs-lisp; lexical-binding: t -*-

(eldev-use-package-archive 'gnu-elpa)

(setq eldev-build-treat-warnings-as-errors t)
(setf eldev-project-loading-mode 'byte-compiled)
(setq sentence-end-double-space nil)
(setq eldev-files-to-package `(:and ,eldev-files-to-package
                                    (concat "!extras/*")))

(eldev-use-plugin 'autoloads)

(eldev-add-loading-roots 'test "test")
(eldev-add-extra-dependencies
 '(test emacs)
 '(:package tempel :version "0.8" :optional t)
 '(:package yasnippet :version "0.14.0" :optional t))

(eldev-defoption mistty-test-bash-exe (&optional path)
  "Tests look for Bash at PATH."
  :options        (--bash)
  :optional-value PATH
  :for-command    test
  (setq mistty-test-bash-exe (executable-find path)))

(eldev-defoption mistty-test-zsh-exe (&optional path)
  "Tests look for Zsh at PATH. Empty to skip zsh tests."
  :options        (--zsh)
  :optional-value PATH
  :for-command    test
  (setq mistty-test-zsh-exe (executable-find path)))

(eldev-defoption mistty-test-fish-exe (&optional path)
  "Tests look for Fish at PATH. Empty to skip fish tests."
  :options        (--fish)
  :optional-value PATH
  :for-command    test
  (setq mistty-test-fish-exe (executable-find path)))

(eldev-defoption mistty-test-python-exe (&optional path)
  "Tests look for Python at PATH."
  :options        (--python)
  :optional-value PATH
  :for-command    test
  (setq mistty-test-python-exe (executable-find path)))

(eldev-defbuilder mistty-builder-build-info (source target)
  :short-name     "SPHINX-TEXI"
  :message        source-and-target
  :type           many-to-one
  :source-files   "docs/source/*.rst"
  :targets        ("mistty.texi")
  :collect        ":default"
  (eldev-call-process "sphinx-build" '("-M" "texinfo" "docs/source" "docs/build")
                      :forward-output t
                      :die-on-error t)
  ;; Remove the date and version to keep the output stable from change
  ;; to change.
  (with-temp-buffer
    (insert-file-contents "docs/build/texinfo/mistty.texi")
    (goto-char (point-min))
    (search-forward-regexp "@\\*Generated by Sphinx [0-9.]+\\.@\\*")
    (replace-match "@*Generated by Sphinx.@*")
    (goto-char (point-min))
    (search-forward-regexp "@quotation\nMisTTY \\([0-9]+\\.[0-9]+\\), .*$")
    (replace-match "@quotation\nMisTTY \\1")
    (write-file "mistty.texi")))

(eldev-defcommand mistty-html-doc (&rest parameters)
  "Generate documentation HTML into docs/build/html."
  :command        documentation
  :aliases        (html)
  (eldev-call-process "sphinx-build" '("-M" "html" "docs/source" "docs/build")
  :forward-output t
  :die-on-error t))

(eldev-defcleaner mistty-cleaner-docs ()
  "Delete Sphinx build dir"
  :default t
  '("docs/build"))

(eldev-use-plugin 'maintainer)
(setq eldev-release-test-local t)
(defun mistty-release-preparator (version)
  (eldev-with-file-buffer "docs/source/conf.py"
    (dolist (tag '("version" "release"))
      (goto-char (point-min))
      (search-forward-regexp (concat tag " = '\\([0-9.]+\\)' *$"))
      (replace-match
       (format "%s = '%s'" tag (package-version-join version))))))
(add-hook 'eldev-release-preparators #'mistty-release-preparator)
